{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}
{% block topbar_title %}Dashboard{% endblock %}

{% block content %}

<!-- Error banner if API credentials are missing / API is down -->
{% if error %}
<div class="flash-msg flash-error" style="margin-bottom:1.5rem;">
    âš  {{ error }}
</div>
{% endif %}

<!-- â”€â”€ Stat cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
{% if account %}
<div class="stat-grid" id="stat-grid">
    {% for asset in account.assets %}
    <div class="stat-card">
        <div class="label">{{ asset.asset }} Wallet Balance</div>
        <div class="value">{{ "%.4f"|format(asset.walletBalance|float) }}</div>
        <div class="sub">
            Unrealised PnL:
            <span class="{% if asset.unrealizedProfit|float >= 0 %}text-green{% else %}text-red{% endif %}">
                {{ "%.4f"|format(asset.unrealizedProfit|float) }}
            </span>
        </div>
    </div>
    {% endfor %}

    <div class="stat-card">
        <div class="label">Open Positions</div>
        <div class="value">{{ account.positions|length }}</div>
        <div class="sub">Active futures positions</div>
    </div>

    <div class="stat-card">
        <div class="label">Recent Orders</div>
        <div class="value">{{ orders|length }}</div>
        <div class="sub">Latest history from Binance</div>
    </div>
</div>

<!-- â”€â”€ Open positions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card" style="margin-bottom:1.5rem;">
    <div class="flex justify-between items-center" style="margin-bottom:.75rem;">
        <p class="card-title" style="margin-bottom:0;">Open Positions</p>
        <button class="btn btn-ghost btn-sm" onclick="refreshAccount()">â†» Refresh</button>
    </div>

    {% if account.positions %}
    <div class="tbl-wrap">
        <table>
            <thead>
                <tr>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Qty</th>
                    <th>Entry Price</th>
                    <th>Mark Price</th>
                    <th>Unrealised PnL</th>
                    <th>Leverage</th>
                </tr>
            </thead>
            <tbody>
                {% for pos in account.positions %}
                <tr>
                    <td class="fw-600">{{ pos.symbol }}</td>
                    <td>
                        {% if pos.positionAmt|float > 0 %}
                        <span class="badge badge-green">LONG</span>
                        {% else %}
                        <span class="badge badge-red">SHORT</span>
                        {% endif %}
                    </td>
                    <td>{{ pos.positionAmt }}</td>
                    <td>{{ pos.entryPrice }}</td>
                    <td>{{ pos.markPrice }}</td>
                    <td class="{% if pos.unrealizedProfit|float >= 0 %}text-green{% else %}text-red{% endif %} fw-600">
                        {{ "%.4f"|format(pos.unrealizedProfit|float) }}
                    </td>
                    <td>{{ pos.leverage }}Ã—</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ðŸ“­</div>
        No open positions
    </div>
    {% endif %}
</div>

{% else %}
<!-- Account data unavailable â€” show placeholder stat cards -->
<div class="stat-grid" style="margin-bottom:1.5rem;">
    <div class="stat-card">
        <div class="label">Status</div>
        <div class="value" style="font-size:1rem;color:var(--text-muted);">No data</div>
        <div class="sub">Check your .env credentials</div>
    </div>
</div>
{% endif %}

<!-- â”€â”€ Recent order history â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div class="card">
    <div class="flex justify-between items-center" style="margin-bottom:.75rem;">
        <p class="card-title" style="margin-bottom:0;">Recent Activity <span class="text-muted"
                style="font-weight:400;text-transform:none;letter-spacing:0;">(live from API)</span></p>
        <a href="{{ url_for('order_form') }}" class="btn btn-primary btn-sm">+ Place Order</a>
    </div>

    {% if orders %}
    <div class="tbl-wrap">
        <table>
            <thead>
                <tr>
                    <th>Time</th>
                    <th>Order ID</th>
                    <th>Symbol</th>
                    <th>Side</th>
                    <th>Type</th>
                    <th>Qty</th>
                    <th>Price</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for o in orders %}
                <tr>
                    <td class="text-muted">{{ o.timestamp }}</td>
                    <td class="fw-600">{{ o.orderId }}</td>
                    <td>{{ o.symbol }}</td>
                    <td>
                        <span class="badge {% if o.side == 'BUY' %}badge-green{% else %}badge-red{% endif %}">
                            {{ o.side }}
                        </span>
                    </td>
                    <td><span class="badge badge-gray">{{ o.type }}</span></td>
                    <td>{{ o.qty }}</td>
                    <td>{{ o.price }}</td>
                    <td>
                        {% if o.status == 'FILLED' %}
                        <span class="badge badge-green">FILLED</span>
                        {% elif o.status == 'NEW' %}
                        <span class="badge badge-yellow">NEW</span>
                        {% elif o.status in ('CANCELED','REJECTED','EXPIRED') %}
                        <span class="badge badge-red">{{ o.status }}</span>
                        {% else %}
                        <span class="badge badge-gray">{{ o.status }}</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="empty-state">
        <div class="empty-icon">ðŸ“‹</div>
        No recent orders found on your account.<br />
        <a href="{{ url_for('order_form') }}" style="margin-top:.5rem;display:inline-block;">Place your first order
            â†’</a>
    </div>
    {% endif %}
</div>

{% endblock %}

{% block scripts %}
<script>
    async function refreshAccount() {
        try {
            const res = await fetch('/api/account');
            if (!res.ok) return;
            // Simple reload to re-render template with fresh data
            window.location.reload();
        } catch (e) { console.error(e); }
    }
</script>
{% endblock %}