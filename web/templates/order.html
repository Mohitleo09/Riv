{% extends "base.html" %}
{% block title %}Place Order{% endblock %}
{% block topbar_title %}Place Order{% endblock %}

{% block content %}

<div style="max-width:680px;">

    <!-- Price ticker -->
    <div class="flex items-center justify-between" style="margin-bottom:1.25rem;">
        <div>
            <h2 style="font-size:1.1rem;margin-bottom:.2rem;">New Futures Order</h2>
            <p class="text-muted" style="font-size:.83rem;">Binance USDT-M Testnet — all trades are simulated</p>
        </div>
        <div class="price-ticker" id="price-ticker">
            <div class="spinner" id="ticker-spinner"></div>
            <span id="ticker-symbol">—</span>
            <span class="price-val" id="ticker-price">—</span>
            <span class="text-muted" style="font-size:.72rem;">USDT</span>
        </div>
    </div>

    <div class="card">
        <form method="POST" action="{{ url_for('submit_order') }}" id="order-form" novalidate>

            <div class="form-grid">

                <!-- Symbol -->
                <div class="form-group">
                    <label for="symbol">Symbol</label>
                    <input type="text" id="symbol" name="symbol" placeholder="e.g. BTCUSDT"
                        value="{{ request.form.get('symbol', '') }}" autocomplete="off" required />
                    <span class="field-hint">Trading pair — uppercase, no slash</span>
                </div>

                <!-- Side -->
                <div class="form-group">
                    <label for="side">Side</label>
                    <select id="side" name="side" required>
                        <option value="" disabled {% if not request.form.get('side') %}selected{% endif %}>Select side
                        </option>
                        <option value="BUY" {% if request.form.get('side')=='BUY' %}selected{% endif %}>BUY — Long /
                            Cover short</option>
                        <option value="SELL" {% if request.form.get('side')=='SELL' %}selected{% endif %}>SELL — Short /
                            Close long</option>
                    </select>
                </div>

                <!-- Order type -->
                <div class="form-group">
                    <label for="type">Order Type</label>
                    <select id="type" name="type" required>
                        <option value="" disabled {% if not request.form.get('type') %}selected{% endif %}>Select type
                        </option>
                        <option value="MARKET" {% if request.form.get('type')=='MARKET' %}selected{% endif %}>MARKET —
                            Execute at current price</option>
                        <option value="LIMIT" {% if request.form.get('type')=='LIMIT' %}selected{% endif %}>LIMIT —
                            Execute at specified price</option>
                        <option value="STOP_MARKET" {% if request.form.get('type')=='STOP_MARKET' %}selected{% endif %}>
                            STOP MARKET — Trigger at stop price</option>
                    </select>
                </div>

                <!-- Quantity -->
                <div class="form-group">
                    <label for="qty">Quantity</label>
                    <input type="number" id="qty" name="qty" placeholder="e.g. 0.01" step="any" min="0"
                        value="{{ request.form.get('qty', '') }}" required />
                    <span class="field-hint">Number of contracts / coin units</span>
                </div>

                <!-- Limit price (LIMIT only) -->
                <div class="form-group conditional-field hidden" id="price-field">
                    <label for="price">Limit Price <span style="color:var(--accent);">*</span></label>
                    <input type="number" id="price" name="price" placeholder="e.g. 85000" step="any" min="0"
                        value="{{ request.form.get('price', '') }}" />
                    <span class="field-hint">Order fills only at this price or better</span>
                </div>

                <!-- Stop price (STOP_MARKET only) -->
                <div class="form-group conditional-field hidden" id="stop-price-field">
                    <label for="stop_price">Stop Price <span style="color:var(--accent);">*</span></label>
                    <input type="number" id="stop_price" name="stop_price" placeholder="e.g. 83000" step="any" min="0"
                        value="{{ request.form.get('stop_price', '') }}" />
                    <span class="field-hint">Trigger price for the stop market order</span>
                </div>

                <!-- Time-in-force (LIMIT only) -->
                <div class="form-group conditional-field hidden" id="tif-field">
                    <label for="tif">Time In Force</label>
                    <select id="tif" name="tif">
                        <option value="GTC" {% if request.form.get('tif', 'GTC' )=='GTC' %}selected{% endif %}>GTC —
                            Good Till Cancelled</option>
                        <option value="IOC" {% if request.form.get('tif')=='IOC' %}selected{% endif %}>IOC — Immediate
                            Or Cancel</option>
                        <option value="FOK" {% if request.form.get('tif')=='FOK' %}selected{% endif %}>FOK — Fill Or
                            Kill</option>
                    </select>
                </div>

            </div><!-- /form-grid -->

            <hr class="divider" />

            <!-- Order summary preview -->
            <div id="order-summary"
                style="margin-bottom:1.25rem;font-size:.83rem;color:var(--text-muted);display:none;">
                <span id="summary-text"></span>
            </div>

            <div class="flex gap-1">
                <button type="submit" class="btn btn-primary" id="submit-btn">
                    ➤ Place Order
                </button>
                <a href="{{ url_for('dashboard') }}" class="btn btn-ghost">Cancel</a>
            </div>

        </form>
    </div><!-- /card -->

</div>

{% endblock %}

{% block scripts %}
<script>
    const typeEl = document.getElementById('type');
    const symbolEl = document.getElementById('symbol');
    const sideEl = document.getElementById('side');
    const qtyEl = document.getElementById('qty');
    const priceEl = document.getElementById('price');
    const priceF = document.getElementById('price-field');
    const stopF = document.getElementById('stop-price-field');
    const tifF = document.getElementById('tif-field');
    const summary = document.getElementById('order-summary');
    const sumText = document.getElementById('summary-text');
    const submitBtn = document.getElementById('submit-btn');

    // ── Show/hide conditional fields ──────────────────────────────────────
    function updateFields() {
        const t = typeEl.value;
        priceF.classList.toggle('hidden', t !== 'LIMIT');
        stopF.classList.toggle('hidden', t !== 'STOP_MARKET');
        tifF.classList.toggle('hidden', t !== 'LIMIT');
        updateSummary();
    }

    // ── Live order summary ────────────────────────────────────────────────
    function updateSummary() {
        const sym = symbolEl.value.trim().toUpperCase() || '—';
        const side = sideEl.value || '—';
        const type = typeEl.value || '—';
        const qty = qtyEl.value || '—';
        const price = priceEl.value || '';

        let text = `${side} ${qty} ${sym} @ ${type}`;
        if (type === 'LIMIT' && price) text += ` — limit $${price}`;
        sumText.textContent = text;
        summary.style.display = (side && type && qty) ? 'block' : 'none';
    }

    typeEl.addEventListener('change', updateFields);
    [symbolEl, sideEl, qtyEl, priceEl].forEach(el => el.addEventListener('input', updateSummary));

    // ── Price ticker ──────────────────────────────────────────────────────
    let tickerTimer = null;

    async function fetchPrice(symbol) {
        if (!symbol || symbol.length < 3) return;
        document.getElementById('ticker-spinner').style.display = 'block';
        try {
            const res = await fetch(`/api/price/${symbol.toUpperCase()}`);
            const data = await res.json();
            if (data.price) {
                document.getElementById('ticker-symbol').textContent = data.symbol;
                document.getElementById('ticker-price').textContent = parseFloat(data.price).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            } else {
                document.getElementById('ticker-symbol').textContent = '—';
                document.getElementById('ticker-price').textContent = '—';
            }
        } catch (e) {
            document.getElementById('ticker-price').textContent = 'error';
        } finally {
            document.getElementById('ticker-spinner').style.display = 'none';
        }
    }

    symbolEl.addEventListener('input', () => {
        clearTimeout(tickerTimer);
        tickerTimer = setTimeout(() => fetchPrice(symbolEl.value.trim()), 700);
    });

    // ── Client-side validation ────────────────────────────────────────────
    document.getElementById('order-form').addEventListener('submit', function (e) {
        const errors = [];
        if (!symbolEl.value.trim()) errors.push('Symbol is required.');
        if (!sideEl.value) errors.push('Side is required.');
        if (!typeEl.value) errors.push('Order type is required.');
        if (!qtyEl.value || parseFloat(qtyEl.value) <= 0) errors.push('Quantity must be greater than zero.');
        if (typeEl.value === 'LIMIT' && (!priceEl.value || parseFloat(priceEl.value) <= 0))
            errors.push('Limit price is required and must be > 0.');
        if (typeEl.value === 'STOP_MARKET') {
            const sp = document.getElementById('stop_price').value;
            if (!sp || parseFloat(sp) <= 0) errors.push('Stop price is required and must be > 0.');
        }

        if (errors.length) {
            e.preventDefault();
            alert('Please fix the following:\n\n• ' + errors.join('\n• '));
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'Submitting…';
    });

    // ── Init ──────────────────────────────────────────────────────────────
    updateFields();
    if (symbolEl.value.trim()) fetchPrice(symbolEl.value.trim());
</script>
{% endblock %}